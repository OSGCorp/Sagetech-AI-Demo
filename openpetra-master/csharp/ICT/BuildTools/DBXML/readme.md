# C# Database XML Subproject Of OpenPetra

The OpenPetra is a C# program that provides administrative management capabilities for non-profit organizations. The program handles contact management, accounting, and sponsorship while supporting international operations. This sub-project implements the database schema definition and parsing infrastructure along with XML-based configuration management. This provides these capabilities to the OpenPetra program:

- Database schema representation in memory
- XML-based database definition parsing
- Type conversion between SQL and .NET types
- Automated schema generation and validation
- Relationship management between database tables

## Identified Design Elements

1. **Schema Definition Store**: The TDataDefinitionStore class serves as a container for all database structure elements, providing methods to retrieve, add, and manipulate tables and sequences
2. **XML Schema Parser**: TDataDefinitionParser extends TXMLParser to read and validate database schema definitions from XML files
3. **Type Mapping System**: Automatic conversion between SQL and .NET types ensures data integrity across the application stack
4. **Dependency Management**: Tables are sorted by dependencies to ensure proper creation order and relationship integrity
5. **Legacy Support**: The parser includes compatibility options like SupportPetra2xLegacyStandard for maintaining backward compatibility

## Overview
The architecture emphasizes a clear separation between schema definition and implementation, allowing for database-agnostic operations. The XML-based approach provides a declarative way to define database structures that can be validated, documented, and transformed into various outputs including SQL scripts and code-generated data access layers. This design supports OpenPetra's need for cross-platform compatibility and extensibility while maintaining strict data integrity requirements for financial and administrative operations.

## Business Functions

### Database Schema Management
- `dataDefinitionStore.cs` : Defines data structures for database schema representation in OpenPetra's build tools.
- `dataDefinitionParser.cs` : XML parser for database schema definitions in OpenPetra that reads table structures, fields, constraints, and sequences.

## Files
### dataDefinitionParser.cs

TDataDefinitionParser implements a specialized XML parser for reading database schema definitions in OpenPetra. It parses XML files containing table definitions, fields, constraints (primary/foreign/unique keys), indexes, and sequences, populating a TDataDefinitionStore object with the structured data. The parser validates field properties, handles relationships between tables, and supports automatic generation of standard fields. Key methods include ParseDocument, ParseTable, ParseTableField, ParseConstraint, ParseIndex, and ParseSequence. Important classes include TDataDefinitionParser which extends TXMLParser, with properties like SupportPetra2xLegacyStandard to handle legacy standards.

 **Code Landmarks**
- `Line 125`: Validates primary key fields are marked as NOT NULL, with special handling for legacy standards
- `Line 171`: Automatically marks fields as part of primary or unique keys for constraint tracking
- `Line 237`: Special handling for different field types including varchar length calculations
### dataDefinitionStore.cs

dataDefinitionStore.cs implements classes that represent database schema elements in memory for OpenPetra's build tools. The file defines TTable, TTableField, TConstraint, TIndex, TIndexField, TSequence, and TDataDefinitionStore classes that model database tables, columns, constraints, indexes, and sequences. Key functionality includes generating proper naming conventions, managing relationships between tables, sorting tables by dependencies, converting between SQL and .NET types, and preparing auto-generated fields. The TDataDefinitionStore class serves as the main container for all database structure elements, with methods to retrieve, add, and manipulate tables and sequences. The code supports database schema generation, documentation, and data access code generation.

 **Code Landmarks**
- `Line 149`: TTable.NiceTableName and NiceFieldName methods implement naming convention transformations from SQL to C# style
- `Line 382`: TopologicalSort algorithm arranges tables by dependencies for proper database creation/deletion order
- `Line 525`: ToOdbcType method maps database field types to ODBC types for data access
- `Line 1006`: PrepareLinks method establishes cross-references between tables based on foreign key relationships
- `Line 1017`: PrepareAutoGeneratedFields adds standard audit fields to tables for tracking creation and modification

[Generated by the Sage AI expert workbench: 2025-03-30 02:22:57  https://sage-tech.ai/workbench]: #